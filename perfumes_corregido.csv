import pandas as pd
import streamlit as st
import random

# --- CONFIGURACI√ìN DE LA P√ÅGINA ---
st.set_page_config(
    page_title="YourParfum",
    page_icon="üå∏",
    layout="wide",
    initial_sidebar_state="collapsed",
)

# --- ESTILOS CSS PARA UN DISE√ëO PROFESIONAL Y MINIMALISTA ---
def load_css():
    st.markdown("""
    <style>
        /* --- FUENTES Y COLORES BASE --- */
        html, body, [class*="st-"] {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #FFFFFF; /* Fondo blanco puro */
            color: #1a1a1a; /* Negro suave para texto */
        }

        /* --- T√çTULOS Y CABECERAS --- */
        h1, h2, h3 {
            font-family: 'Garamond', 'Georgia', serif; /* Fuente m√°s elegante */
            font-weight: 400;
            color: #000000;
        }
        
        /* --- LAYOUT PRINCIPAL --- */
        .main .block-container {
            padding-top: 2rem;
            padding-bottom: 2rem;
            padding-left: 5rem;
            padding-right: 5rem;
        }
        
        /* Contenedor de la gu√≠a personalizada para centrarla */
        .guide-container {
            width: 70%;
            margin: 0 auto;
            text-align: center;
        }

        /* --- BARRA DE B√öSQUEDA --- */
        div.stTextInput>div>div>input {
            border: 1px solid #ccc;
            padding: 10px 15px;
            border-radius: 0;
            box-shadow: none;
        }
        div.stTextInput>div>div>input:focus {
            border-color: #000;
            box-shadow: none;
        }

        /* --- TARJETA DE PRODUCTO REFINADA --- */
        .perfume-card {
            border: none; /* Sin bordes para un look m√°s limpio */
            padding: 10px;
            margin-bottom: 20px;
            text-align: center;
            transition: transform 0.2s ease-in-out;
        }
        .perfume-card:hover {
            transform: scale(1.02);
        }
        .perfume-card img {
            max-height: 200px;
            margin-bottom: 20px;
        }
        .perfume-name {
            font-size: 1.1em;
            font-weight: 500; /* Letra m√°s fina */
            color: #000;
            text-transform: uppercase; /* MAY√öSCULAS como en Zara */
            letter-spacing: 0.05em;
        }
        .perfume-brand {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        
        /* Estilo refinado para el precio */
        .perfume-price {
            font-size: 1.1em;
            font-weight: 400;
            color: #000;
            margin-bottom: 20px;
        }
        
        /* Notas Olfativas */
        .perfume-notes {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 15px;
            font-style: italic;
        }

        /* Nueva secci√≥n para el dupe, sin fondo y minimalista */
        .dupe-section {
            border-top: 1px solid #eee; /* Un separador sutil */
            padding-top: 15px;
            margin-top: 20px;
        }
        .dupe-title {
            font-size: 0.8em;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .dupe-name {
            font-weight: 500;
            color: #000;
            margin-bottom: 10px;
        }

        /* --- BOTONES MINIMALISTAS --- */
        a.buy-button {
            display: block; width: 100%; text-align: center; text-decoration: none;
            border-radius: 0; /* Sin bordes redondeados */
            padding: 12px 0; margin-top: 8px; font-weight: 500;
            transition: all 0.3s ease;
            letter-spacing: 0.05em;
        }
        a.original-button {
            border: 1px solid #000;
            background-color: transparent;
            color: #000;
        }
        a.original-button:hover {
            background-color: #000;
            color: #fff;
        }
        a.dupe-button {
            border: 1px solid #000;
            background-color: #000;
            color: #fff;
        }
        a.dupe-button:hover {
            background-color: #333;
            border-color: #333;
        }
    </style>
    """, unsafe_allow_html=True)

# --- CARGA Y PROCESAMIENTO DE DATOS ---
@st.cache_data
def load_data(file_path):
    try:
        df = pd.read_csv(file_path)
        
        # Procesar la columna de notas
        df['Notas'] = df['Notas'].astype(str).str.split(',').apply(lambda x: [item.strip().lower() for item in x])
        
        # A√±adir columna 'Estaci√≥n' derivada de 'Ocasi√≥n' para un filtrado m√°s inteligente
        def extract_season(occasion):
            occasion = str(occasion).lower()
            if 'verano' in occasion: return 'Verano'
            if 'invierno' in occasion: return 'Invierno'
            if 'oto√±o' in occasion: return 'Oto√±o'
            if 'primavera' in occasion: return 'Primavera'
            return 'Cualquiera'
        
        df['Estaci√≥n'] = df['Ocasi√≥n'].apply(extract_season)
        
        # Crear una columna de popularidad ficticia para el scoring
        df['Popularidad'] = df.index.map(lambda i: (len(df) - i) * random.uniform(0.8, 1.2))
        
        return df
    except FileNotFoundError:
        st.error(f"Error: El archivo '{file_path}' no se encontr√≥. Aseg√∫rate de que el archivo est√° en la misma carpeta.")
        return None

# --- FUNCI√ìN PARA MOSTRAR UNA TARJETA DE PERFUME ---
def display_perfume_card(perfume):
    notes_formatted = ", ".join([note.capitalize() for note in perfume['Notas']])
    
    with st.container():
        st.markdown(f"""
        <div class="perfume-card">
            <img src="{perfume['Imagen (URL)']}" alt="{perfume['Nombre']}">
            <div class="perfume-name">{perfume['Nombre']}</div>
            <div class="perfume-brand">{perfume['Marca']}</div>
            
            <div class="perfume-notes">{notes_formatted}</div>

            <div class="perfume-price">{perfume['Precio (‚Ç¨)']} ‚Ç¨</div>
            
            <a href="{perfume['Enlace original']}" target="_blank" class="buy-button original-button">Comprar Original</a>
            
            <div class="dupe-section">
                <div class="dupe-title">Alternativa de **{perfume['Nombre']}**</div>
                <div class="dupe-name">{perfume['Dupe barato']}</div>
                <a href="{perfume['Enlace dupe']}" target="_blank" class="buy-button dupe-button">Comprar Alternativa</a>
            </div>
        </div>
        """, unsafe_allow_html=True)

# --- ALGORITMO DE PUNTUACI√ìN (SCORING) ---
def score_perfumes(df, user_prefs):
    df['score'] = 0.0
    
    # Puntuaci√≥n base por popularidad
    df['score'] = df['Popularidad']

    # Puntos por coincidencia de Tipo de aroma
    df.loc[df['Tipo de aroma'] == user_prefs['Tipo de aroma'], 'score'] += 15
    
    # Puntos por coincidencia de Ocasi√≥n
    df.loc[df['Ocasi√≥n'].str.contains(user_prefs['Ocasi√≥n'], case=False), 'score'] += 10
    
    # Puntos por coincidencia de Intensidad
    df.loc[df['Intensidad'] == user_prefs['Intensidad'], 'score'] += 8
    
    # Puntos por coincidencia de Notas
    def check_notes(row):
        return sum(1 for note in user_prefs['Notas'] if note.lower() in row['Notas'])
    df['score'] += df.apply(check_notes, axis=1) * 5

    # Filtro final por presupuesto
    df = df[df['Precio (‚Ç¨)'] <= user_prefs['Presupuesto']].copy()
    
    return df.sort_values(by='score', ascending=False)

# --- L√ìGICA PRINCIPAL DE LA APLICACI√ìN ---
def main():
    load_css()
    df = load_data('perfumes_corregido.csv')

    if df is None:
        return

    # --- CABECERA ---
    st.markdown("<h1 style='text-align: center; font-size: 3.5em;'>YourParfum</h1>", unsafe_allow_html=True)
    st.markdown("<h3 style='text-align: center; font-weight: 300; margin-top: -20px;'>Encuentra tu aroma perfecto.</h3>", unsafe_allow_html=True)
    st.markdown("---")
    
    # Inicializar estado de la sesi√≥n
    if 'step' not in st.session_state:
        st.session_state.step = 0
        st.session_state.prefs = {}
        st.session_state.results = pd.DataFrame()

    tab1, tab2 = st.tabs(["‚ú® Gu√≠a Personalizada", "üîé Explorar Cat√°logo"])
    
    # --- PESTA√ëA 1: GU√çA PERSONALIZADA ---
    with tab1:
        st.header("Tu Recomendaci√≥n Ideal")
        
        # L√≥gica del flujo de preguntas
        if st.session_state.step == 0:
            st.markdown("<p style='text-align: center;'><b>Paso 1:</b> Para empezar, ¬øpara qui√©n buscas?</p>", unsafe_allow_html=True)
            selected_genero = st.radio("", ['Hombre', 'Mujer', 'Unisex'], horizontal=True)
            if st.button("Siguiente", key="guia_siguiente_1"):
                st.session_state.prefs['G√©nero'] = selected_genero
                st.session_state.step = 1
                st.rerun()

        elif st.session_state.step == 1:
            st.markdown("<p style='text-align: center;'><b>Paso 2:</b> Ahora, elige el tipo de aroma y la ocasi√≥n.</p>", unsafe_allow_html=True)
            df_genero = df[df['G√©nero'].isin([st.session_state.prefs['G√©nero'], 'Unisex'])].copy()
            
            col1, col2 = st.columns(2)
            with col1:
                st.session_state.prefs['Tipo de aroma'] = st.selectbox("Tipo de aroma:", sorted(df_genero['Tipo de aroma'].unique().tolist()))
            with col2:
                st.session_state.prefs['Ocasi√≥n'] = st.selectbox("Ocasi√≥n de uso:", sorted(df_genero['Ocasi√≥n'].unique().tolist()))
                
            if st.button("Siguiente", key="guia_siguiente_2"):
                st.session_state.step = 2
                st.rerun()

        elif st.session_state.step == 2:
            st.markdown("<p style='text-align: center;'><b>Paso 3:</b> ¬øQu√© intensidad prefieres y cu√°l es tu presupuesto?</p>", unsafe_allow_html=True)
            df_genero = df[df['G√©nero'].isin([st.session_state.prefs['G√©nero'], 'Unisex'])].copy()
            
            col1, col2 = st.columns(2)
            with col1:
                st.session_state.prefs['Intensidad'] = st.selectbox("Intensidad preferida:", sorted(df_genero['Intensidad'].unique().tolist()))
            with col2:
                st.session_state.prefs['Presupuesto'] = st.slider("Presupuesto m√°ximo (‚Ç¨):", min_value=10, max_value=int(df_genero['Precio (‚Ç¨)'].max()), value=150, step=5)
            
            st.info("Opcional: puedes escribir notas que te gusten para afinar la b√∫squeda.")
            user_notes = st.text_input("Notas (ej. vainilla, lim√≥n):", "")
            st.session_state.prefs['Notas'] = [note.strip().lower() for note in user_notes.split(',')] if user_notes else []

            if st.button("Ver mi recomendaci√≥n", key="guia_finalizar"):
                df_filtrado = df[df['G√©nero'].isin([st.session_state.prefs['G√©nero'], 'Unisex'])].copy()
                st.session_state.results = score_perfumes(df_filtrado, st.session_state.prefs)
                st.session_state.step = 3
                st.rerun()

        elif st.session_state.step == 3:
            st.header("‚ú® ¬°Aqu√≠ est√° tu perfume ideal! ‚ú®")
            
            if not st.session_state.results.empty:
                cols = st.columns(min(3, len(st.session_state.results)))
                for i, (idx, perfume) in enumerate(st.session_state.results.iloc[:3].iterrows()):
                    with cols[i]:
                        display_perfume_card(perfume)
                
                st.markdown("---")
                st.info("¬øNo te convence? Prueba a reiniciar la b√∫squeda.")
                if st.button("Reiniciar Gu√≠a", key="reiniciar_guia"):
                    st.session_state.step = 0
                    st.rerun()
            else:
                st.warning("No se encontraron perfumes que coincidan con tu b√∫squeda. Intenta con otros filtros.")
                if st.button("Reiniciar Gu√≠a", key="reiniciar_guia"):
                    st.session_state.step = 0
                    st.rerun()

    # --- PESTA√ëA 2: EXPLORAR CAT√ÅLOGO ---
    with tab2:
        st.header("Explora todo nuestro cat√°logo")

        # Barra de b√∫squeda para el cat√°logo
        search_term = st.text_input('Busca por nombre, marca o notas olfativas:', '').strip().lower()

        # Filtros del cat√°logo
        col1, col2, col3, col4 = st.columns(4)
        with col1:
            marcas = ['Todas'] + sorted(df['Marca'].unique().tolist())
            selected_marca = st.selectbox("Marca:", marcas)
        with col2:
            tipos_aroma = ['Cualquiera'] + sorted(df['Tipo de aroma'].unique().tolist())
            selected_tipo = st.selectbox("Tipo de aroma:", tipos_aroma)
        with col3:
            intensidades = ['Cualquiera'] + sorted(df['Intensidad'].unique().tolist())
            selected_intensidad = st.selectbox("Intensidad:", intensidades)
        with col4:
            ocasiones = ['Cualquiera'] + sorted(df['Ocasi√≥n'].unique().tolist())
            selected_ocasion = st.selectbox("Ocasi√≥n:", ocasiones)
        
        # Aplicar filtros
        filtros = (df['G√©nero'].isin([st.session_state.prefs.get('G√©nero', 'Hombre'), 'Unisex']))
        if selected_marca != 'Todas': filtros &= (df['Marca'] == selected_marca)
        if selected_tipo != 'Cualquiera': filtros &= (df['Tipo de aroma'] == selected_tipo)
        if selected_intensidad != 'Cualquiera': filtros &= (df['Intensidad'] == selected_intensidad)
        if selected_ocasion != 'Cualquiera': filtros &= (df['Ocasi√≥n'] == selected_ocasion)

        # Filtro de b√∫squeda global
        if search_term:
            filtros &= df.apply(lambda row: 
                search_term in str(row['Nombre']).lower() or 
                search_term in str(row['Marca']).lower() or 
                any(search_term in note.lower() for note in row['Notas']), axis=1)

        resultados = df[filtros]

        st.markdown("---")
        st.markdown(f"**Perfumes encontrados: {len(resultados)}**")

        if not resultados.empty:
            resultados_por_pagina = 9
            total_paginas = (len(resultados) - 1) // resultados_por_pagina + 1
            if 'page' not in st.session_state: st.session_state.page = 1
            
            pag_col1, pag_col2, pag_col3 = st.columns([1,2,1])
            with pag_col1:
                if st.button('‚¨ÖÔ∏è Anterior', key="prev_button") and st.session_state.page > 1:
                    st.session_state.page -= 1
                    st.rerun()
            with pag_col3:
                if st.button('Siguiente ‚û°Ô∏è', key="next_button") and st.session_state.page < total_paginas:
                    st.session_state.page += 1
                    st.rerun()
            with pag_col2:
                 st.write(f"P√°gina {st.session_state.page} de {total_paginas}")

            start_idx = (st.session_state.page - 1) * resultados_por_pagina
            end_idx = start_idx + resultados_por_pagina
            
            for i in range(start_idx, end_idx, 3):
                cols = st.columns(3)
                for j, (idx, row) in enumerate(resultados.iloc[i:i+3].iterrows()):
                    with cols[j]:
                        display_perfume_card(row)
        else:
            st.warning("No hay perfumes que coincidan con tu b√∫squeda. Intenta con otros filtros.")

    # --- PIE DE P√ÅGINA ---
    st.markdown("---")
    st.markdown('<p style="text-align: center; color: grey;">Creado por Miguel Poza con üñ§</p>', unsafe_allow_html=True)

if __name__ == "__main__":
    main()
